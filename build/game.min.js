"use strict";var Extendable={extend:function(e){var t=Object.create(this);for(var i in e)t[i]=e[i];return"construct"in t&&t.construct(),t}},Game=Extendable.extend({nextId:0,pieces:[],el:document.getElementById("room"),add:function(e){return e.create(),null===e.id?(e.id=this.nextId,this.pieces[this.nextId]=e,this.nextId++):this.pieces[e.id]=e,this.show(e),e.id},addAll:function(e){for(var t=0,i=e.length;i>t;t++)this.add(e[t])},remove:function(e){this.el.removeChild(e.el),delete this.pieces[e.id]},hide:function(e){this.el.removeChild(e.el)},show:function(e){this.el.appendChild(this.pieces[e.id].el)},step:function(){for(var e=0,t=this.pieces.length;t>e;e++)this.pieces[e].step()}}),Jarl=Game.extend({room:null,players:[],turn:null,beginTurns:function(){},clockSort:function(){},takeTurnSquare:function(e,t,i){"player"===this.turn.type&&(i(this.room.grid[e/32][t/32],this.room.itemGrid[e/32][t/32]),this.beginTurns())},takeTurn:function(e){"player"===this.turn.type&&(e(),this.beginTurns())},changeRoom:function(e){this.hide(this.room),this.room=e,this.add(e),Messages.move(32*e.width,0)},addPlayer:function(e){this.add(e),this.players,e.x=32*Math.floor(this.room.width/2),e.y=32*Math.floor(this.room.height/2),e.room=this.room,e.bind(),e.step(),this.turn=e},begin:function(){this.room=LevelGen.begin(),this.add(this.room),Messages.move(32*this.room.width)}}),Messages={el:document.getElementById("text"),last:null,push:function(e){var t=document.createElement("div");t.innerHTML=e,t.className="mess",this.el.insertBefore(t,this.last),this.last=t},move:function(e,t){this.el.style.left=e+"px",this.el.style.top=t+"px"}};Messages.push('Welcome to Jarl <br> push "?" for instructions'),Messages.push("You entered level 1");var Gamepiece=Extendable.extend({x:0,y:0,z:0,id:null,blocking:!1,className:"fixed trans",trigger:function(){},create:function(){this.el=document.createElement("img"),this.el.className=this.className,this.el.src=this.src,this.el.style.zIndex=this.z,this.step()},step:function(){var e=this.flipped?" flipped":"";this.el.style.left=this.x+"px",this.el.style.top=this.y+"px",this.el.className=this.className+e},move:function(e,t){this.x=e,this.y=t,this.step()},moveRel:function(e,t){var i=this;Jarl.takeTurnSquare(this.x+e,this.y+t,function(n,o){if(n.blocking!==!1||null!==o&&o.blocking!==!1)i.el.style.left=i.x+.5*e+"px",i.el.style.top=i.y+.5*t+"px",window.setTimeout(function(){i.el.style.left=i.x+"px",i.el.style.top=i.y+"px"},200);else{var s=i.x+e;i.flipped=s===i.x?i.flipped:s<i.x?!0:!1,i.x+=e,i.y+=t,i.step()}n.trigger(i),null!=o&&o.trigger(i)})}}),Player=Gamepiece.extend({type:"player",blocking:!0,src:"night.min.gif",z:4,bind:function(){var e=this;Mousetrap.bind(["left","h"],function(){e.moveRel(-32,0)},"keyup"),Mousetrap.bind(["right","l"],function(){e.moveRel(32,0)},"keyup"),Mousetrap.bind(["up","k"],function(){e.moveRel(0,-32)},"keyup"),Mousetrap.bind(["down","j"],function(){e.moveRel(0,32)},"keyup"),Mousetrap.bind(["y"],function(){e.moveRel(-32,-32)},"keyup"),Mousetrap.bind(["u"],function(){e.moveRel(32,-32)},"keyup"),Mousetrap.bind(["n"],function(){e.moveRel(-32,32)},"keyup"),Mousetrap.bind(["m"],function(){e.moveRel(32,32)},"keyup"),Mousetrap.bind(["?"],function(){var e=["---Controls---","arrow keys - move","~ or ~","h - left","j - down","k - up","l - right","y - up-left","u - up-right","n - down-left","m - down-right","","i - view inventory","---GamePlay---","move twards an enemy to attack"];Messages.push(e.join("<br />"))})}}),Wall=Gamepiece.extend({type:"wall",blocking:!0,src:"wall.min.gif"}),Door=Gamepiece.extend({type:"door",src:"door.gif",trigger:function(e){e.room=this.to;var t=this,i=this.to.doorPlacement(Directions.opposite(t.placement));e.move(32*i.x,32*i.y),"player"===e.type&&Jarl.changeRoom(this.to,this.placement)}});Door.create();var Ground=Gamepiece.extend({type:"ground",src:"ground.min.gif"});Ground.create();var Room=Extendable.extend({init:function(e,t,i){this.x=0,this.y=0,this.height=e,this.width=t,this.grid=[],this.itemGrid=[];for(var n=0;t>n;n++){this.grid[n]=[],this.itemGrid[n]=[];for(var o=0;e>o;o++)this.grid[n][o]=Ground.extend({x:32*n,y:32*o}),this.itemGrid[n][o]=null}this.doorObj=i,this.createWalls(),this.createItems()},doorPlacement:function(e,t){var i=0,n=0;switch(0!==t&&(t=t||1),e){case"top":n=t,i=Math.floor(this.width/2);break;case"bottom":n=this.height-1-t,i=Math.floor(this.width/2);break;case"left":i=t,n=Math.floor(this.height/2);break;case"right":i=this.width-1-t,n=Math.floor(this.height/2)}return{x:i,y:n}},createWalls:function(){this.createHozWall(0,this.doorObj.top),this.createHozWall(this.height-1,this.doorObj.bottom),this.createVertWall(0,this.doorObj.left),this.createVertWall(this.width-1,this.doorObj.right)},createItems:function(){this.types[this.type](this)},types:{beginning:function(e){var t=Math.floor(e.width/2)-2,i=Math.floor(e.height/2);e.itemGrid[t][i]=Items.sign.extend({text:"SIGN: Welcome to the dungeons of Jarl, many have entered, few have returned.",x:32*t,y:32*i,room:e});var n=e.doorPlacement("bottom",0);e.itemGrid[n.x][n.y]=Items.finalDoor.extend({x:32*n.x,y:32*n.y,room:e})},random:function(){},end:function(e){var t=Math.floor(e.width/2),i=Math.floor(e.height/2);e.itemGrid[t][i]=Items.finalKey.extend({x:32*t,y:32*i,room:e})}},removeItem:function(e,t){e/=32,t/=32;var i=this.itemGrid[e][t];this.itemGrid[e][t]=null,this.el.removeChild(i.el)},createVertWall:function(e,t){for(var i=this.height;i--;)this.grid[e][i]=Wall.extend({x:32*e,y:32*i});if(null!==t){var n=Math.floor(this.height/2);this.grid[e][n]=t,t.x=32*e,t.y=32*n}},createHozWall:function(e,t){for(var i=this.width;i--;)this.grid[i][e]=Wall.extend({x:32*i,y:32*e});if(null!==t){var n=Math.floor(this.width/2);this.grid[n][e]=t,t.x=32*n,t.y=32*e}},create:function(){this.el=document.createElement("div"),this.el.width=32*this.width,this.el.height=32*this.height,this.el.class="fixed",this.el.style.top=0,this.el.style.left=0;for(var e=0;e<this.width;e++)for(var t=0;t<this.height;t++){var i=this.grid[e][t],n=this.itemGrid[e][t];null!==i&&(i.create(),this.el.appendChild(i.el),i.step()),null!==n&&(n.create(),this.el.appendChild(n.el),n.step())}},log:function(){for(var e="",t=0;t<this.height;t++){for(var i="",n=0;n<this.width;n++){var o,s=this.grid[n][t];if("undefined"!=typeof s){if(null!==s&&"undefined"!=typeof s.type&&"door"==s.type)o="d";else switch(s){case"wall":o="w";break;case"hidden":o="h";break;case null:o=".";break;default:o="~"}i+=o}else o="?",i+=o}e+=i+"\n"}console.log(e)},apply:function(){}}),Directions=Extendable.extend({directions:["left","top","right","bottom"],randomNum:function(){return Math.floor(4*Math.random())},random:function(){return this.numToName(this.randomNum())},opposite:function(e){return"undefined"==typeof e&&console.error("direction does not exist",e),this.numToName((this.nameToNum(e)+2)%4)},numToName:function(e){return"undefined"==typeof this.directions[e]&&console.error("invalid dirNum"),this.directions[e]},nameToNum:function(e){return-1===this.directions.indexOf(e)&&console.error("invalid dirName"),this.directions.indexOf(e)}}),LevelGen=Extendable.extend({depth:3,branchChanse:.5,begin:function(){var e=Room.extend({type:"beginning",depth:this.depth}),t=this.roomGen(e,"top",!0),i=Door.extend({room:e,to:t,placement:"top"}),n=Math.floor(10*Math.random())+10,o=Math.floor(10*Math.random())+10;return e.init(n,o,{top:i,left:null,right:null,bottom:null}),e},roomGen:function(e,t,i){var n="",o={top:null,bottom:null,left:null,right:null},s=Room.extend({depth:e.depth-1,isRightPath:i,type:"random"});if(o[Directions.opposite(t)]=Door.extend({room:s,to:e,placement:Directions.opposite(t)}),s.depth>1){if(i){do n=Directions.random();while(null!==o[n]);o[n]=Door.extend({room:s,to:this.roomGen(s,n,!0),placement:n})}for(var r in o){var h=Math.random()>.2;h&&null===o[r]&&(o[r]=Door.extend({from:s,to:this.roomGen(s,r,!1),placement:r}))}}else i&&(s.type="end");var l=Math.floor(10*Math.random())+5,a=Math.floor(10*Math.random())+5;return s.init(a,l,o),s}}),Items={finalKey:Gamepiece.extend({name:"Final Key",description:"The way out of this place",src:"finalKey.gif",trigger:function(){Inventory.add(this),this.room.removeItem(this.x,this.y)}}),finalDoor:Gamepiece.extend({src:"finalDoor.gif",trigger:function(){Inventory.contains("Final Key")?alert("Congradulations you won Jarl! Thanks for playing my game I hope you enjoyed it!"):Messages.push("Doors locked tight! The Only way out is to find the key.")}}),sign:Gamepiece.extend({src:"sign.gif",blocking:!0,trigger:function(){Messages.push(this.text)}})},Inventory=Extendable.extend({size:20,items:[],selected:0,show:!1,construct:function(){this.el=document.getElementById("inventory"),this.el.style.display=this.show?"":"none";var e=this;Mousetrap.bind(["i"],function(){e.toggleShow()}),this.update()},add:function(e){this.items.length<this.size&&(this.items.push(e),Messages.push(e.name+" was added to your invenetory")),this.update()},create:function(){},toggleShow:function(){this.show=!this.show,this.el.style.display=this.show?"":"none",console.log("inventory",this.el)},update:function(){for(var e="<p><strong>INVENTORY</strong><p><ul>",t=0,i=this.items.length;i>t;t++){var n=this.items[t];e+="<li class='"+(this.selected==t?"selected":"")+"'>",e+="<img class='left' src='"+n.src+"' />",e+="<strong>"+n.name+"</strong>: "+n.description,e+="</li>"}0===this.items.length&&(e+="<li>Inventory is empty</li>"),e+="</ul>",this.el.innerHTML=e},contains:function(e){for(var t=0,i=this.items.length;i>t;t++){var n=this.items[t];if(n.name===e)return!0}return!1}});Jarl.begin(),Jarl.addPlayer(Player);